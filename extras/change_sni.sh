#!/bin/bash

# –ü—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É X-ray (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π)
CONFIG_FILE="/usr/local/etc/xray/config.json"

# –ü—Ä–æ–≤–µ—Ä–∫–∞: –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–∫—Ä–∏–ø—Ç –æ—Ç root
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (sudo)"
  exit 1
fi

echo "============================================="
echo "üõ°Ô∏è  –ú–∞—Å—Ç–µ—Ä —Å–º–µ–Ω—ã SNI (–ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞)"
echo "============================================="
echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –µ—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ."
echo "–ú—ã –∑–∞–º–∞—Å–∫–∏—Ä—É–µ–º —Ç—Ä–∞—Ñ–∏–∫ –ø–æ–¥ —Ä–æ—Å—Å–∏–π—Å–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã (–ë–µ–ª—ã–µ —Å–ø–∏—Å–∫–∏)."
echo ""
echo "–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–º–µ–Ω –¥–ª—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏:"
echo "1) VK CDN (sun9-75.userapi.com) - –ù–∞–¥–µ–∂–Ω–æ –¥–ª—è –†–§"
echo "2) Ozon Static (st.ozon.ru) - –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç Ozon"
echo "3) Wildberries (static-basket-01.wb.ru) - –°—Ç–∞—Ç–∏–∫–∞ WB"
echo "4) –Ø–Ω–¥–µ–∫—Å (yandex.ru) - –ë–∞–∑–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç"
echo "5) Google (dl.google.com) - –í–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –±—ã–ª–æ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)"
echo "6) –í–≤–µ—Å—Ç–∏ —Å–≤–æ–π –¥–æ–º–µ–Ω –≤—Ä—É—á–Ω—É—é"

read -p "–í–∞—à –≤—ã–±–æ—Ä [1-6]: " choice

case $choice in
  1) DOMAIN="sun9-75.userapi.com";;
  2) DOMAIN="st.ozon.ru";;
  3) DOMAIN="static-basket-01.wb.ru";;
  4) DOMAIN="yandex.ru";;
  5) DOMAIN="dl.google.com";;
  6) read -p "–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω (–±–µ–∑ https://): " DOMAIN;;
  *) echo "–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"; exit 1;;
esac

echo "‚è≥ –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å–∫–∏—Ä–æ–≤–∫—É –ø–æ–¥: $DOMAIN..."

# –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –∫–æ–Ω—Ñ–∏–≥–∞
cp $CONFIG_FILE "$CONFIG_FILE.bak"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ jq (—É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JSON), –µ—Å–ª–∏ –Ω–µ—Ç - —Å—Ç–∞–≤–∏–º
if ! command -v jq &> /dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º jq –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ JSON..."
    apt-get update -qq && apt-get install -y jq
fi

# –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–º–µ–Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–π —á–µ—Ä–µ–∑ jq
# –ú–µ–Ω—è–µ–º dest (–ø–æ—Ä—Ç 443) –∏ –º–∞—Å—Å–∏–≤ serverNames
tmp=$(mktemp)
jq --arg d "$DOMAIN:443" --arg n "$DOMAIN" \
   '.inbounds[0].streamSettings.realitySettings.dest = $d | .inbounds[0].streamSettings.realitySettings.serverNames = [$n]' \
   $CONFIG_FILE > "$tmp" && mv "$tmp" $CONFIG_FILE

# === –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ ===
chmod 644 $CONFIG_FILE
# ====================================================

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª—É–∂–±—ã X-ray..."
systemctl restart xray

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
if systemctl is-active --quiet xray; then
    echo "‚úÖ –£—Å–ø–µ—à–Ω–æ! –í–∞—à —Å–µ—Ä–≤–µ—Ä —Ç–µ–ø–µ—Ä—å –º–∞—Å–∫–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥: $DOMAIN"
    echo "‚ö†Ô∏è –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å SNI –≤ –∫–ª–∏–µ–Ω—Ç–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ/–ü–ö, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è!"
else
    echo "‚ùå –û—à–∏–±–∫–∞! –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±—ç–∫–∞–ø..."
    mv "$CONFIG_FILE.bak" $CONFIG_FILE
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –∏ –Ω–∞ –±—ç–∫–∞–ø, –µ—Å–ª–∏ –ø—Ä–∏—à–ª–æ—Å—å –æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å—Å—è
    chmod 644 $CONFIG_FILE
    systemctl restart xray
    echo "–ë—ç–∫–∞–ø –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏."
fi
